## Ubuntu开机自起

# 在/usr/lib/systemd/system下编写服务⽂件

创建服务文件（如：a.service）

a.service中配置

```ini
[Unit]
Description=Run x.sh on startup  # 服务描述
#After=network.target  # 等待网络启动完成（可选，根据脚本需求调整）
#Requires=network.target  # 强制依赖网络（可选）

[Service]
Type=simple  # 简单类型（直接执行命令）
User=root  # 运行用户（根据需求改为普通用户，如你的用户名）
WorkingDirectory=/path/to/script/dir  # 脚本所在目录（重要！避免相对路径问题）
ExecStart=/bin/bash /path/to/x.sh  # 绝对路径执行脚本（推荐用 bash 解释器）
Restart=on-failure  # 失败后自动重启（可选）
RestartSec=5  # 重启间隔（秒，可选）

[Install]
WantedBy=multi-user.target  # 多用户模式启动（适用于服务器）
# 若需图形界面启动后运行，改为 WantedBy=graphical.target
```

## **启用并启动服务​**​

```bash
sudo systemctl daemon-reload  # 重新加载 systemd 配置
sudo systemctl enable x-script.service  # 开机自动启用服务
sudo systemctl start x-script.service  # 立即启动服务（可选，测试用）
```

> **记得提权，（sudo chmod 777 a.service）**
> 
> 会生成一个相同文件在`/etc/systemd/system/` 目录下
> 
> 记得不能加注释
> 
> 修改.service后也要重新加载

## 配置脚本

```bash
#!/bin/bash
export MVCAM_SDK_PATH=/opt/MVS

export MVCAM_COMMON_RUNENV=/opt/MVS/lib
export LD_LIBRARY_PATH=/opt/MVS/lib/64:/opt/MVS/lib/32:$LD_LIBRARY_PATH

source /opt/ros/noetic/setup.bash 
sleep 5 
source /home/robocon/RC/project5_ws/devel/setup.bash
sleep 5 
roslaunch yolopkg yolo.launch
```

> #!/bin/bash 一定要加
> 
> sleep 5 要给一定缓冲时间
> 
> 也要提权

## 相关指令

```bash
sudo systemctl restart a.service  #重启服务
sudo systemctl kill a.service # 杀死服务
journalctl -u a.service -b #查看最新输出
journalctl -u ros_program.service -f #查看⽇志输出，-f实时查看
ls -l 查看文件权限
```

## **手动通过ROS命令终止节点​**​

#### 1. 查看当前运行的ROS节点

在终端执行以下命令，列出所有正在运行的ROS节点：

```bash
rosnode list
```

输出可能类似（根据你的节点名称调整）：

```bash
/rosout
/yolo_node
/camera_driver
```

#### 2. 终止特定节点

使用`rosnode kill`命令终止目标节点（替换`<node_name>`为实际节点名）：

```bash
rosnode kill /yolo_node   # 终止单个节点
rosnode kill /camera_driver /yolo_node  # 终止多个节点（空格分隔）
```

### ** 临时方案：修改设备权限（重启后失效）​**​

如果急需使用，可临时修改串口设备的权限（不推荐长期使用，重启后会恢复）：

```bash
# 假设你的串口设备是 /dev/ttyUSB0（根据实际设备调整）
sudo chmod 666 /dev/ttyUSB0
```

## 要在开机后手动停止正在运行的 `roscore`

#### 方法 1：使用 `pgrep` 直接查找

```bash
pgrep -f roscore
```

### **​步骤 2：终止 `roscore` 进程​**​

找到 PID 后，使用 `kill` 命令终止进程。

#### 普通终止（推荐）

（还可以通过htop查看）

```bash
kill <PID>
```

## 编写 C++ 程序调用脚本​

在 ROS 节点中集成脚本执行功能，示例代码（`run_script_node.cpp`）：

```cpp
#include <ros/ros.h>
#include <cstdlib>  // 包含 system() 函数

// 执行脚本的函数（返回值：0 成功，非 0 失败）
int run_script(const std::string& script_path) {
    ROS_INFO("尝试执行脚本：%s", script_path.c_str());

    // 使用 system() 执行脚本（绝对路径更安全）
    int ret = system(script_path.c_str());

    if (ret == 0) {
        ROS_INFO("脚本执行成功！");
    } else {
        ROS_ERROR("脚本执行失败！错误码：%d", ret);
    }
    return ret;
}

int main(int argc, char** argv) {
    // 初始化 ROS 节点
    ros::init(argc, argv, "script_runner_node");
    ros::NodeHandle nh;

    // 指定脚本路径（推荐绝对路径，避免相对路径问题）
    std::string script_path = "/home/robocon/scripts/my_script.sh";  // 替换为你的脚本路径

    // 执行脚本（可在节点启动时直接运行，或在回调中触发）
    run_script(script_path);

    // 保持节点运行（可选，根据需求调整）
    ros::spin();  // 若不需要持续运行，可移除此句
    return 0;
}
```

### **2. 解决方案：将用户加入 `dialout` 组（推荐）​**​

Linux 系统中，串口设备的默认访问组是 `dialout`。将当前用户加入该组后，即可获得访问权限。

#### 步骤：

1. ​**​将用户添加到 `dialout` 组​**​：

```bash
sudo usermod -aG dialout $USER
```

- `-a`：追加用户到组（不覆盖原有组）。
- `-G dialout`：指定目标组为 `dialout`。
- `$USER`：当前用户名（自动替换为你的用户名）。
